<UserControl x:Class="LearningTrainer.Views.StatisticsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:viewmodels="clr-namespace:LearningTrainer.ViewModels"
             xmlns:converters="clr-namespace:LearningTrainer.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="{DynamicResource BackgroundBrush}">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InvertedBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:PercentToWidthConverter x:Key="PercentToWidthConverter"/>
        <converters:CountToOpacityConverter x:Key="CountToOpacityConverter"/>
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
        <converters:ActivityToHeatmapColorConverter x:Key="ActivityToHeatmapColorConverter"/>
        <converters:ProgressToWidthConverter x:Key="ProgressToWidthConverter"/>

        <!-- Stat Card Style - Compact -->
        <Style x:Key="StatCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource SecondaryMainBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" BlurRadius="6" Opacity="0.08"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact Card for dense layouts -->
        <Style x:Key="CompactCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource SecondaryMainBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="12"/>
        </Style>

        <!-- Section Header Style - Tighter -->
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>

        <!-- Stat Value Style - Compact -->
        <Style x:Key="StatValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="26"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
        </Style>

        <!-- Stat Label Style - Tighter -->
        <Style x:Key="StatLabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{DynamicResource SecondaryTextBrush}"/>
            <Setter Property="Margin" Value="0,2,0,0"/>
        </Style>

        <!-- Heatmap cell style -->
        <Style x:Key="HeatmapCellStyle" TargetType="Border">
            <Setter Property="Width" Value="14"/>
            <Setter Property="Height" Value="14"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Margin" Value="2"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Loading Overlay -->
        <Border Background="{DynamicResource BackgroundBrush}" 
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="100">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{DynamicResource Loc.Loading}" 
                           Margin="0,16,0,0"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" 
                      Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
            <StackPanel Margin="20,16">

                <!-- Header -->
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="ðŸ“Š" FontSize="22" Margin="0,0,10,0"/>
                        <TextBlock Text="{DynamicResource Loc.Statistics.Title}" 
                                   FontSize="22" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <ComboBox ItemsSource="{Binding PeriodOptions}"
                                  SelectedValue="{Binding SelectedPeriod}"
                                  SelectedValuePath="Value"
                                  DisplayMemberPath="DisplayName"
                                  MinWidth="150"
                                  Margin="0,0,12,0"/>
                        <Button Command="{Binding RefreshCommand}"
                                Padding="12,8"
                                Background="{DynamicResource AccentBrush}"
                                Foreground="White"
                                BorderThickness="0"
                                Cursor="Hand">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ”„" Margin="0,0,8,0"/>
                                <TextBlock Text="{DynamicResource Loc.Refresh}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <!-- Stats Cards Row -->
                <UniformGrid Columns="5" Margin="0,0,0,16">
                    <!-- Learned Words -->
                    <Border Style="{StaticResource StatCardStyle}" Margin="0,0,8,0" BorderThickness="3,0,0,0" BorderBrush="#10B981">
                        <StackPanel>
                            <TextBlock Text="ðŸ“š" FontSize="18" Opacity="0.8"/>
                            <TextBlock Text="{Binding Statistics.LearnedWords}" Style="{StaticResource StatValueStyle}"/>
                            <TextBlock Text="{DynamicResource Loc.Statistics.LearnedWords}" Style="{StaticResource StatLabelStyle}"/>
                            <Border Background="#E8FDF5" CornerRadius="4" Padding="6,2" Margin="0,6,0,0" HorizontalAlignment="Left">
                                <TextBlock Foreground="#10B981" FontSize="10">
                                    <Run Text="+"/>
                                    <Run Text="{Binding Statistics.WordsLearnedThisWeek, Mode=OneWay}"/>
                                    <Run Text=" Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ"/>
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </Border>
                    
                    <!-- Current Streak -->
                    <Border Style="{StaticResource StatCardStyle}" Margin="4,0" BorderThickness="3,0,0,0" BorderBrush="#F59E0B">
                        <StackPanel>
                            <TextBlock Text="ðŸ”¥" FontSize="18" Opacity="0.8"/>
                            <TextBlock Text="{Binding Statistics.CurrentStreak}" Style="{StaticResource StatValueStyle}"/>
                            <TextBlock Text="{DynamicResource Loc.Statistics.CurrentStreak}" Style="{StaticResource StatLabelStyle}"/>
                            <Border Background="#FEF9E7" CornerRadius="4" Padding="6,2" Margin="0,6,0,0" HorizontalAlignment="Left">
                                <TextBlock Foreground="#F59E0B" FontSize="10">
                                    <Run Text="Ð›ÑƒÑ‡ÑˆÐ¸Ð¹: "/>
                                    <Run Text="{Binding Statistics.BestStreak, Mode=OneWay}"/>
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </Border>
                    
                    <!-- Accuracy -->
                    <Border Style="{StaticResource StatCardStyle}" Margin="4,0" BorderThickness="3,0,0,0" BorderBrush="#3B82F6">
                        <StackPanel>
                            <TextBlock Text="ðŸŽ¯" FontSize="18" Opacity="0.8"/>
                            <TextBlock Text="{Binding Statistics.OverallAccuracy, StringFormat={}{0:P0}}" Style="{StaticResource StatValueStyle}"/>
                            <TextBlock Text="{DynamicResource Loc.Statistics.Accuracy}" Style="{StaticResource StatLabelStyle}"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Learning Time -->
                    <Border Style="{StaticResource StatCardStyle}" Margin="4,0" BorderThickness="3,0,0,0" BorderBrush="#8B5CF6">
                        <StackPanel>
                            <TextBlock Text="â±ï¸" FontSize="18" Opacity="0.8"/>
                            <TextBlock Text="{Binding FormattedLearningTime}" Style="{StaticResource StatValueStyle}"/>
                            <TextBlock Text="{DynamicResource Loc.Statistics.LearningTime}" Style="{StaticResource StatLabelStyle}"/>
                            <Border Background="#F3E8FF" CornerRadius="4" Padding="6,2" Margin="0,6,0,0" HorizontalAlignment="Left">
                                <TextBlock Foreground="#8B5CF6" FontSize="10">
                                    <Run Text="{Binding Statistics.TotalSessions, Mode=OneWay}"/>
                                    <Run Text=" ÑÐµÑÑÐ¸Ð¹"/>
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </Border>
                    
                    <!-- Leaderboard Position -->
                    <Border Style="{StaticResource StatCardStyle}" Margin="8,0,0,0" BorderThickness="3,0,0,0" BorderBrush="#EC4899">
                        <StackPanel>
                            <TextBlock Text="ðŸ†" FontSize="18" Opacity="0.8"/>
                            <TextBlock Style="{StaticResource StatValueStyle}">
                                <Run Text="#"/>
                                <Run Text="{Binding Statistics.LeaderboardPosition.GlobalRank, Mode=OneWay, FallbackValue='-'}"/>
                            </TextBlock>
                            <TextBlock Text="{DynamicResource Loc.Statistics.Position}" Style="{StaticResource StatLabelStyle}"/>
                            <Border Background="#FDF2F8" CornerRadius="4" Padding="6,2" Margin="0,6,0,0" HorizontalAlignment="Left"
                                    Visibility="{Binding Statistics.LeaderboardPosition, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Foreground="#EC4899" FontSize="10">
                                    <Run Text="Ð¢Ð¾Ð¿ "/>
                                    <Run Text="{Binding Statistics.LeaderboardPosition.Percentile, Mode=OneWay, StringFormat={}{0:F1}}"/>
                                    <Run Text="%"/>
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </Border>
                </UniformGrid>

                <!-- Two Column Layout -->
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Knowledge Distribution -->
                    <Border Grid.Column="0" Style="{StaticResource StatCardStyle}" Margin="0,0,8,0">
                        <StackPanel>
                            <TextBlock Text="ðŸ“Š Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÑ€Ð¾Ð²Ð½ÑÐ¼" Style="{StaticResource SectionHeaderStyle}"/>
                            <ItemsControl ItemsSource="{Binding Statistics.KnowledgeDistribution}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="100"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="40"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Orientation="Horizontal">
                                                <Border Width="20" Height="20" CornerRadius="4" Margin="0,0,6,0">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding Color}"/>
                                                    </Border.Background>
                                                    <TextBlock Text="{Binding Level}" 
                                                               HorizontalAlignment="Center" 
                                                               VerticalAlignment="Center"
                                                               Foreground="White" FontWeight="Bold" FontSize="9"/>
                                                </Border>
                                                <TextBlock Text="{Binding LevelName}" 
                                                           VerticalAlignment="Center" FontSize="12"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            </StackPanel>

                                            <Border Grid.Column="1" Height="6" CornerRadius="3" 
                                                    Background="{DynamicResource SurfaceBrush}" Margin="8,0">
                                                <Border CornerRadius="3" HorizontalAlignment="Left">
                                                    <Border.Width>
                                                        <MultiBinding Converter="{StaticResource PercentToWidthConverter}">
                                                            <Binding Path="Percentage"/>
                                                            <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Border}"/>
                                                        </MultiBinding>
                                                    </Border.Width>
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding Color}"/>
                                                    </Border.Background>
                                                </Border>
                                            </Border>

                                            <TextBlock Grid.Column="2" Text="{Binding Count}" 
                                                       HorizontalAlignment="Right" FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- Activity Heatmap (GitHub-style) -->
                    <Border Grid.Column="1" Style="{StaticResource StatCardStyle}" Margin="8,0,0,0">
                        <StackPanel>
                            <Grid Margin="0,0,0,10">
                                <TextBlock Text="ðŸ“… ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ" Style="{StaticResource SectionHeaderStyle}" Margin="0"/>
                                <TextBlock HorizontalAlignment="Right" VerticalAlignment="Center"
                                           FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}">
                                    <Run Text="Ð—Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 4 Ð½ÐµÐ´ÐµÐ»Ð¸"/>
                                </TextBlock>
                            </Grid>

                            <!-- Heatmap Grid - 4 weeks x 7 days -->
                            <Grid HorizontalAlignment="Left">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Day labels -->
                                <StackPanel Grid.Column="0" Margin="0,0,6,0">
                                    <TextBlock Text="" Height="18"/>
                                    <TextBlock Text="ÐŸÐ½" FontSize="9" Height="18" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                    <TextBlock Text="" Height="18"/>
                                    <TextBlock Text="Ð¡Ñ€" FontSize="9" Height="18" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                    <TextBlock Text="" Height="18"/>
                                    <TextBlock Text="ÐŸÑ‚" FontSize="9" Height="18" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                    <TextBlock Text="" Height="18"/>
                                </StackPanel>

                                <!-- Heatmap cells -->
                                <ItemsControl Grid.Column="1" ItemsSource="{Binding Statistics.DailyActivity}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Rows="7" Columns="4"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource HeatmapCellStyle}"
                                                    Background="{Binding WordsReviewed, Converter={StaticResource ActivityToHeatmapColorConverter}}"
                                                    ToolTipService.InitialShowDelay="200">
                                                <Border.ToolTip>
                                                    <StackPanel>
                                                        <TextBlock FontWeight="SemiBold">
                                                            <Run Text="{Binding WordsReviewed, Mode=OneWay}"/>
                                                            <Run Text=" ÑÐ»Ð¾Ð²"/>
                                                        </TextBlock>
                                                        <TextBlock Text="{Binding Date, StringFormat={}{0:d MMMM}}" 
                                                                   Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                                                    </StackPanel>
                                                </Border.ToolTip>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>

                            <!-- Legend -->
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,0" HorizontalAlignment="Right">
                                <TextBlock Text="ÐœÐµÐ½ÑŒÑˆÐµ" FontSize="9" VerticalAlignment="Center" Margin="0,0,6,0"
                                           Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <Border Width="12" Height="12" CornerRadius="2" Background="#EBEDF0" Margin="1,0"/>
                                <Border Width="12" Height="12" CornerRadius="2" Background="#9BE9A8" Margin="1,0"/>
                                <Border Width="12" Height="12" CornerRadius="2" Background="#40C463" Margin="1,0"/>
                                <Border Width="12" Height="12" CornerRadius="2" Background="#30A14E" Margin="1,0"/>
                                <Border Width="12" Height="12" CornerRadius="2" Background="#216E39" Margin="1,0"/>
                                <TextBlock Text="Ð‘Ð¾Ð»ÑŒÑˆÐµ" FontSize="9" VerticalAlignment="Center" Margin="6,0,0,0"
                                           Foreground="{DynamicResource SecondaryTextBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Dictionary Progress -->
                <Border Style="{StaticResource StatCardStyle}" Margin="0,0,0,16"
                        Visibility="{Binding Statistics.DictionaryStatistics.Count, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="ðŸ“– ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ð¿Ð¾ ÑÐ»Ð¾Ð²Ð°Ñ€ÑÐ¼" Style="{StaticResource SectionHeaderStyle}"/>
                        <ItemsControl ItemsSource="{Binding Statistics.DictionaryStatistics}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="180"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="70"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel>
                                            <TextBlock Text="{Binding DictionaryName}" 
                                                       FontWeight="SemiBold" FontSize="12"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" FontSize="10">
                                                <Run Text="{Binding LearnedWords, Mode=OneWay}"/>
                                                <Run Text=" / "/>
                                                <Run Text="{Binding TotalWords, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <Grid Grid.Column="1" Margin="12,0">
                                            <Border Height="6" CornerRadius="3" Background="{DynamicResource SurfaceBrush}"/>
                                            <Border Height="6" CornerRadius="3" Background="#10B981" HorizontalAlignment="Left">
                                                <Border.Width>
                                                    <MultiBinding Converter="{StaticResource PercentToWidthConverter}">
                                                        <Binding Path="CompletionPercent"/>
                                                        <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Grid}"/>
                                                    </MultiBinding>
                                                </Border.Width>
                                            </Border>
                                        </Grid>

                                        <TextBlock Grid.Column="2" 
                                                   Text="{Binding CompletionPercent, StringFormat={}{0:F0}%}"
                                                   HorizontalAlignment="Center" FontSize="12"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>

                                        <TextBlock Grid.Column="3" HorizontalAlignment="Right" FontSize="11"
                                                   Foreground="{DynamicResource TextSecondaryBrush}">
                                            <Run Text="ðŸŽ¯ "/>
                                            <Run Text="{Binding Accuracy, Mode=OneWay, StringFormat={}{0:P0}}"/>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Difficult Words -->
                <Border Style="{StaticResource StatCardStyle}" Margin="0,0,0,16"
                        Visibility="{Binding Statistics.DifficultWords.Count, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="âš ï¸ Ð¡Ð»Ð¾Ð¶Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°" Style="{StaticResource SectionHeaderStyle}" Margin="0"/>
                            <Button Command="{Binding PracticeDifficultWordsCommand}"
                                    HorizontalAlignment="Right"
                                    Padding="12,6"
                                    Background="{DynamicResource AccentBrush}"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="â–¶ï¸" Margin="0,0,6,0" FontSize="10"/>
                                    <TextBlock Text="Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ" FontSize="12"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <ItemsControl ItemsSource="{Binding Statistics.DifficultWords}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderBrush}" Padding="0,8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="120"/>
                                                <ColumnDefinition Width="80"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Text="{Binding OriginalWord}" 
                                                       FontWeight="SemiBold" FontSize="12"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Translation}" FontSize="12"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Border Grid.Column="2" Background="{DynamicResource SurfaceBrush}" 
                                                    CornerRadius="3" Padding="6,2" HorizontalAlignment="Left">
                                                <TextBlock Text="{Binding DictionaryName}" FontSize="10"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Border>
                                            <TextBlock Grid.Column="3" HorizontalAlignment="Right" FontSize="11" Foreground="#EF4444">
                                                <Run Text="{Binding ErrorRate, Mode=OneWay, StringFormat={}{0:P0}}"/>
                                            </TextBlock>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Achievements - Summary View -->
                <Border Style="{StaticResource StatCardStyle}">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ… Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ" Style="{StaticResource SectionHeaderStyle}" Margin="0"/>
                            </StackPanel>
                            <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="10,4">
                                    <TextBlock FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="âœ… "/>
                                        <Run Text="{Binding UnlockedAchievementsCount, Mode=OneWay}"/>
                                        <Run Text=" / "/>
                                        <Run Text="{Binding TotalAchievementsCount, Mode=OneWay}"/>
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </Grid>

                        <!-- Active Achievements Grid (recent + in-progress only) -->
                        <ItemsControl ItemsSource="{Binding ActiveAchievements}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="3" Rows="2"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="4" Padding="10" CornerRadius="10"
                                            Background="{DynamicResource SurfaceBrush}"
                                            Opacity="{Binding IsUnlocked, Converter={StaticResource BoolToOpacityConverter}}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Icon with unlocked indicator -->
                                            <Grid Margin="0,0,10,0">
                                                <TextBlock Text="{Binding Icon}" FontSize="24" VerticalAlignment="Center"/>
                                                <Border Width="10" Height="10" CornerRadius="5" 
                                                        Background="#10B981" 
                                                        VerticalAlignment="Top" HorizontalAlignment="Right"
                                                        Margin="0,-2,-2,0"
                                                        Visibility="{Binding IsUnlocked, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                            </Grid>

                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="12"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Description}" FontSize="10" 
                                                           TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           MaxWidth="150"/>

                                                <!-- Progress bar for locked achievements -->
                                                <Grid Margin="0,6,0,0"
                                                      Visibility="{Binding IsUnlocked, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                    <Border Height="4" CornerRadius="2" Background="{DynamicResource BorderBrush}"/>
                                                    <Border Height="4" CornerRadius="2" Background="#8B5CF6" HorizontalAlignment="Left">
                                                        <Border.Width>
                                                            <MultiBinding Converter="{StaticResource ProgressToWidthConverter}">
                                                                <Binding Path="Progress"/>
                                                                <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Grid}"/>
                                                            </MultiBinding>
                                                        </Border.Width>
                                                    </Border>
                                                    <TextBlock HorizontalAlignment="Right" Margin="0,-2,0,0"
                                                               FontSize="9" Foreground="{DynamicResource SecondaryTextBrush}">
                                                        <Run Text="{Binding CurrentValue, Mode=OneWay}"/>
                                                        <Run Text="/"/>
                                                        <Run Text="{Binding TargetValue, Mode=OneWay}"/>
                                                    </TextBlock>
                                                </Grid>

                                                <!-- Unlocked date badge -->
                                                <TextBlock Visibility="{Binding IsUnlocked, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                           FontSize="9" Foreground="#10B981" Margin="0,4,0,0">
                                                    <Run Text="âœ“ "/>
                                                    <Run Text="{Binding UnlockedAt, Mode=OneWay, StringFormat={}{0:d MMM}}"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Empty state when no active achievements -->
                        <TextBlock Text="ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ!" 
                                   FontSize="12" Foreground="{DynamicResource SecondaryTextBrush}"
                                   HorizontalAlignment="Center" Margin="0,10,0,0"
                                   Visibility="{Binding ActiveAchievements.Count, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
