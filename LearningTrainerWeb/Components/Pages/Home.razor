@page "/"
@inject IAuthService AuthService
@inject IContentApiService ContentApi

<PageTitle>LearningTrainer - Платформа изучения иностранных языков</PageTitle>

<!-- Hero Section - Full Width -->
<section class="hero-landing">
    <div class="hero-bg-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>
    <div class="hero-content">
        <div class="hero-badge">
            <i class="bi bi-stars me-2"></i> Новая версия 2.0
        </div>
        <h1 class="hero-title">
            Изучай языки с 
            <span class="text-highlight">удовольствием</span>
        </h1>
        <p class="hero-subtitle">
            Платформа для изучения иностранных языков с помощью интервального повторения.
            Создавай словари, изучай правила, отслеживай прогресс.
        </p>
        <div class="hero-actions">
            <a href="@(IsAuthenticated ? "training" : "login")" class="btn btn-hero-primary">
                <i class="bi bi-play-circle me-2"></i>Начать тренировку
            </a>
            <a href="dictionaries" class="btn btn-hero-outline">
                <i class="bi bi-book me-2"></i>Открыть словари
            </a>
        </div>
        <div class="hero-stats">
            <div class="hero-stat">
                <span class="hero-stat-value">@PlatformStats.DictionaryCount+</span>
                <span class="hero-stat-label">Словарей</span>
            </div>
            <div class="hero-stat-divider"></div>
            <div class="hero-stat">
                <span class="hero-stat-value">@PlatformStats.RuleCount+</span>
                <span class="hero-stat-label">Правил</span>
            </div>
            <div class="hero-stat-divider"></div>
            <div class="hero-stat">
                <span class="hero-stat-value">@PlatformStats.UserCount+</span>
                <span class="hero-stat-label">Пользователей</span>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section">
    <div class="section-container">
        <div class="section-header">
            <span class="section-tag">Возможности</span>
            <h2 class="section-title">Всё для эффективного обучения</h2>
            <p class="section-desc">Используйте все инструменты для достижения цели</p>
        </div>

        <div class="features-grid">
            <div class="feature-card-modern">
                <div class="feature-icon-wrap">
                    <div class="feature-icon">
                        <i class="bi bi-mortarboard"></i>
                    </div>
                </div>
                <h3>Тренировка</h3>
                <p>Интервальное повторение по методу SM-2. Система автоматически подбирает слова для повторения.</p>
                <a href="training" class="feature-link">
                    Начать тренировку <i class="bi bi-arrow-right"></i>
                </a>
            </div>

            <div class="feature-card-modern">
                <div class="feature-icon-wrap">
                    <div class="feature-icon feature-icon-accent">
                        <i class="bi bi-book"></i>
                    </div>
                </div>
                <h3>Словари</h3>
                <p>Создавайте собственные словари, добавляйте примеры и транскрипцию. Делитесь с сообществом.</p>
                <a href="dictionaries" class="feature-link">
                    Просмотреть словари <i class="bi bi-arrow-right"></i>
                </a>
            </div>

            <div class="feature-card-modern">
                <div class="feature-icon-wrap">
                    <div class="feature-icon feature-icon-green">
                        <i class="bi bi-journal-text"></i>
                    </div>
                </div>
                <h3>Грамматика</h3>
                <p>Изучайте грамматические правила по языковой грамматике. Материалы для всех уровней.</p>
                <a href="rules" class="feature-link">
                    Просмотреть правила <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Popular Content Section -->
<section class="popular-section">
    <div class="section-container">
        <div class="section-header">
            <span class="section-tag section-tag-fire">
                <i class="bi bi-fire me-1"></i> Популярное
            </span>
            <h2 class="section-title">Лучшее от сообщества</h2>
            <p class="section-desc">Словари и правила с высоким рейтингом от наших пользователей</p>
        </div>

        <div class="popular-grid">
            @if (FeaturedContent != null)
            {
                @foreach (var item in FeaturedContent)
                {
                    <div class="popular-card">
                        <div class="popular-card-header">
                            <span class="popular-type @(item.Type == "Словарь" ? "type-dictionary" : "type-rule")">
                                <i class="bi @(item.Type == "Словарь" ? "bi-book-half" : "bi-journal-bookmark")"></i>
                                @item.Type
                            </span>
                            <div class="popular-rating">
                                <i class="bi bi-star-fill"></i>
                                <span>@item.Rating.ToString("F1")</span>
                            </div>
                        </div>
                        <h4 class="popular-title">@item.Title</h4>
                        <div class="popular-author">
                            <div class="author-avatar">
                                <i class="bi bi-person"></i>
                            </div>
                            <span>@item.Author</span>
                        </div>
                        <div class="popular-card-footer">
                            <span class="popular-downloads">
                                <i class="bi bi-download"></i> @item.Downloads
                            </span>
                            <a href="@(item.Type == "Словарь" ? "dictionaries" : "rules")" class="btn btn-sm btn-card">
                                Подробнее
                            </a>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="cta-section">
    <div class="cta-content">
        <div class="cta-bg-shapes">
            <div class="cta-shape cta-shape-1"></div>
            <div class="cta-shape cta-shape-2"></div>
        </div>
        @if (IsAuthenticated)
        {
            <h2>Продолжайте обучение!</h2>
            <p>Вернитесь к тренировке и закрепите свои знания</p>
            <div class="cta-actions">
                <a href="training" class="btn btn-cta-primary">
                    <i class="bi bi-play-circle me-2"></i>Продолжить тренировку
                </a>
                <a href="my-content" class="btn btn-cta-outline">
                    Мой контент
                </a>
            </div>
        }
        else
        {
            <h2>Готовы начать обучение?</h2>
            <p>Зарегистрируйтесь и присоединяйтесь к тысячам изучающих иностранные языки</p>
            <div class="cta-actions">
                <a href="register" class="btn btn-cta-primary">
                    <i class="bi bi-person-plus me-2"></i>Создать аккаунт
                </a>
                <a href="login" class="btn btn-cta-outline">
                    Войти
                </a>
            </div>
        }
    </div>
</section>

@code {
    private bool IsAuthenticated;
    private List<FeaturedItem>? FeaturedContent;
    private PlatformStatsDto PlatformStats = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await AuthService.InitializeAsync();
            var session = await AuthService.GetCurrentSessionAsync();
            IsAuthenticated = session != null;
        }
        catch
        {
            // Prerendering — JS interop not available
        }

        await LoadFeaturedContent();
    }

    private async Task LoadFeaturedContent()
    {
        try
        {
            var statsTask = ContentApi.GetPlatformStatsAsync();
            var dictionaries = await ContentApi.GetPublicDictionariesAsync(null, null, null, 1, 3);
            var rules = await ContentApi.GetPublicRulesAsync(null, null, 0, 1, 3);

            var items = new List<FeaturedItem>();
            foreach (var d in dictionaries.Items)
                items.Add(new FeaturedItem("Словарь", d.Name, d.AuthorName, d.Rating, d.Downloads));
            foreach (var r in rules.Items)
                items.Add(new FeaturedItem("Правило", r.Title, r.AuthorName, r.Rating, r.Downloads));

            FeaturedContent = items.OrderByDescending(x => x.Rating).Take(6).ToList();

            var platformStats = await statsTask;
            PlatformStats = new PlatformStatsDto
            {
                DictionaryCount = platformStats.DictionaryCount,
                RuleCount = platformStats.RuleCount,
                UserCount = platformStats.UserCount
            };
        }
        catch
        {
            FeaturedContent = new List<FeaturedItem>();
        }
    }

    private record FeaturedItem(string Type, string Title, string Author, double Rating, int Downloads);

    private class PlatformStatsDto
    {
        public int DictionaryCount { get; set; }
        public int RuleCount { get; set; }
        public int UserCount { get; set; }
    }
}
