@page "/training"
@using LearningTrainerWeb.Services
@using LearningTrainerShared.Models
@inject ITrainingApiService TrainingService
@inject IStatisticsApiService StatsService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ - Ingat</PageTitle>

<div class="training-container" @onkeydown="HandleKeyDown" tabindex="0" @ref="trainingContainer">
    @if (!IsAuthenticated)
    {
        <!-- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
        <div class="training-guest">
            <div class="guest-hero">
                <div class="guest-icon">
                    <i class="bi bi-mortarboard"></i>
                </div>
                <h1>–ù–∞—á–Ω–∏—Ç–µ –∏–∑—É—á–∞—Ç—å —Å–ª–æ–≤–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</h1>
                <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                <div class="guest-actions">
                    <a href="login" class="btn btn-primary btn-lg">
                        <i class="bi bi-box-arrow-in-right me-2"></i>–í–æ–π—Ç–∏
                    </a>
                    <a href="register" class="btn btn-outline-primary btn-lg">
                        <i class="bi bi-person-plus me-2"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </div>
            </div>
        </div>
    }
    else if (IsLoading)
    {
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div class="training-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...</p>
        </div>
    }
    else if (DailyPlan == null || (DailyPlan.Stats.TotalReviewCount == 0 && DailyPlan.Stats.TotalNewCount == 0))
    {
        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –Ω–µ—Ç —Å–ª–æ–≤ -->
        <div class="training-empty">
            <div class="empty-icon">
                <i class="bi bi-journal-x"></i>
            </div>
            <h2>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</h2>
            <p>–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</p>
            <div class="empty-actions">
                <button class="btn btn-primary btn-lg" @onclick="InstallStarterPack" disabled="@IsInstallingStarter">
                    @if (IsInstallingStarter)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    else
                    {
                        <i class="bi bi-lightning-charge me-2"></i>
                    }
                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä
                </button>
                <a href="dictionaries" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-book me-2"></i>–ù–∞–π—Ç–∏ —Å–ª–æ–≤–∞—Ä–∏
                </a>
            </div>
            @if (!string.IsNullOrEmpty(StarterMessage))
            {
                <div class="alert @(StarterSuccess ? "alert-success" : "alert-danger") mt-3">
                    @StarterMessage
                </div>
            }
        </div>
    }
    else if (!IsTrainingActive)
    {
        <!-- –û–±–∑–æ—Ä –ø–ª–∞–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
        <div class="daily-plan">
            <div class="plan-header">
                <h1>
                    <i class="bi bi-calendar-check me-2"></i>
                    –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                </h1>
                @if (DailyPlan.Stats.CurrentStreak > 0)
                {
                    <div class="streak-badge">
                        <i class="bi bi-fire"></i>
                        <span>@DailyPlan.Stats.CurrentStreak –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥!</span>
                    </div>
                }
            </div>

            <div class="plan-stats">
                <div class="stat-card stat-review">
                    <div class="stat-icon">
                        <i class="bi bi-arrow-repeat"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">@DailyPlan.Stats.TotalReviewCount</span>
                        <span class="stat-label">–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</span>
                    </div>
                </div>
                <div class="stat-card stat-new">
                    <div class="stat-icon">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">@DailyPlan.Stats.TotalNewCount</span>
                        <span class="stat-label">–ù–æ–≤—ã—Ö —Å–ª–æ–≤</span>
                    </div>
                </div>
                <div class="stat-card stat-difficult">
                    <div class="stat-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">@DailyPlan.Stats.TotalDifficultCount</span>
                        <span class="stat-label">–°–ª–æ–∂–Ω—ã—Ö</span>
                    </div>
                </div>
                <div class="stat-card stat-completed">
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">@DailyPlan.Stats.CompletedToday</span>
                        <span class="stat-label">–°–¥–µ–ª–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</span>
                    </div>
                </div>
            </div>

            <div class="training-modes">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
                <div class="modes-grid">
                    <button class="mode-card" @onclick='() => StartTraining("mixed")' 
                            disabled="@(DailyPlan.Stats.TotalReviewCount == 0 && DailyPlan.Stats.TotalNewCount == 0)">
                        <div class="mode-icon">
                            <i class="bi bi-shuffle"></i>
                        </div>
                        <h4>–°–º–µ—à–∞–Ω–Ω—ã–π</h4>
                        <p>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ + –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</p>
                    </button>
                    <button class="mode-card" @onclick='() => StartTraining("review")'
                            disabled="@(DailyPlan.Stats.TotalReviewCount == 0)">
                        <div class="mode-icon">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                        <h4>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</h4>
                        <p>–¢–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</p>
                    </button>
                    <button class="mode-card" @onclick='() => StartTraining("new")'
                            disabled="@(DailyPlan.Stats.TotalNewCount == 0)">
                        <div class="mode-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <h4>–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞</h4>
                        <p>–ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤</p>
                    </button>
                    <button class="mode-card mode-difficult" @onclick='() => StartTraining("difficult")'
                            disabled="@(DailyPlan.Stats.TotalDifficultCount == 0)">
                        <div class="mode-icon">
                            <i class="bi bi-lightning"></i>
                        </div>
                        <h4>–°–ª–æ–∂–Ω—ã–µ</h4>
                        <p>–°–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏</p>
                    </button>
                </div>
                
                <h3 class="mt-4">–¢–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3>
                <div class="exercise-types">
                    <button class="exercise-type @(ExerciseType == "flashcard" ? "active" : "")" 
                            @onclick='() => SetExerciseType("flashcard")'>
                        <i class="bi bi-card-text"></i>
                        <span>–ö–∞—Ä—Ç–æ—á–∫–∏</span>
                    </button>
                    <button class="exercise-type @(ExerciseType == "mcq" ? "active" : "")" 
                            @onclick='() => SetExerciseType("mcq")'>
                        <i class="bi bi-ui-radios"></i>
                        <span>–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</span>
                    </button>
                    <button class="exercise-type @(ExerciseType == "typing" ? "active" : "")" 
                            @onclick='() => SetExerciseType("typing")'>
                        <i class="bi bi-keyboard"></i>
                        <span>–í–≤–æ–¥</span>
                    </button>
                </div>
            </div>

            <div class="quick-start">
                <button class="btn btn-primary btn-xl" @onclick='() => StartTraining("mixed")'
                        disabled="@(DailyPlan.Stats.TotalReviewCount == 0 && DailyPlan.Stats.TotalNewCount == 0)">
                    <i class="bi bi-play-fill me-2"></i>
                    –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- –ê–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
        <div class="training-session">
            @if (CurrentWord != null)
            {
                <div class="session-progress">
                    <div class="progress-info">
                        <span>–°–ª–æ–≤–æ @(CurrentIndex + 1) –∏–∑ @TrainingWords.Count</span>
                        <span class="correct-count">
                            <i class="bi bi-check-circle text-success"></i> @CorrectCount
                        </span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: @((CurrentIndex + 1) * 100.0 / TrainingWords.Count)%"></div>
                    </div>
                </div>

                @if (ExerciseType == "flashcard")
                {
                    <!-- –†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫ -->
                    <div class="flashcard @(IsAnswerRevealed ? "revealed" : "")">
                        <div class="card-front">
                            <div class="word-dictionary">
                                <i class="bi bi-book"></i> @CurrentWord.DictionaryName
                            </div>
                            <div class="word-main">@CurrentWord.OriginalWord</div>
                            @if (!string.IsNullOrEmpty(CurrentWord.Transcription))
                            {
                                <div class="word-transcription">@CurrentWord.Transcription</div>
                            }
                            <div class="audio-group">
                                <button class="btn-tts" @onclick="SpeakWord" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å">
                                    <i class="bi bi-volume-up-fill"></i>
                                </button>

                                <div class="volume-wrapper">
                                    <button class="btn-volume-toggle" @onclick="ToggleVolumeSlider" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
                                        <i class="@VolumeIcon"></i>
                                    </button>

                                    @if (ShowVolumeSlider)
                                    {
                                        <div class="volume-popover">
                                            <input type="range" 
                                                   min="0" max="1" step="0.01" 
                                                   value="@TtsVolumeFormatted" 
                                                   @oninput="OnVolumeChanged" />
                                            <span class="volume-value">@TtsVolumePercent%</span>
                                        </div>
                                    }
                                </div>
                            </div>
                            @if (!IsAnswerRevealed)
                            {
                                <button class="btn btn-outline-primary btn-lg mt-4" @onclick="RevealAnswer">
                                    <i class="bi bi-eye me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                            }
                        </div>

                        @if (IsAnswerRevealed)
                        {
                            <div class="card-back">
                                <div class="translation">@CurrentWord.Translation</div>
                                @if (!string.IsNullOrEmpty(CurrentWord.Example))
                                {
                                    <div class="example">
                                        <i class="bi bi-chat-quote"></i> @CurrentWord.Example
                                        <button class="btn-tts-sm" @onclick="SpeakExample" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä">
                                            <i class="bi bi-volume-up"></i>
                                        </button>
                                    </div>
                                }
                            </div>

                            <div class="answer-buttons">
                                <button class="btn btn-answer btn-again" @onclick="() => SubmitAnswer(ResponseQuality.Again)" title="–ö–ª–∞–≤–∏—à–∞ 1">
                                    <i class="bi bi-x-lg"></i>
                                    <span>–ù–µ –∑–Ω–∞—é</span>
                                    <small>1</small>
                                </button>
                                <button class="btn btn-answer btn-hard" @onclick="() => SubmitAnswer(ResponseQuality.Hard)" title="–ö–ª–∞–≤–∏—à–∞ 2">
                                    <i class="bi bi-emoji-frown"></i>
                                    <span>–°–ª–æ–∂–Ω–æ</span>
                                    <small>2</small>
                                </button>
                                <button class="btn btn-answer btn-good" @onclick="() => SubmitAnswer(ResponseQuality.Good)" title="–ö–ª–∞–≤–∏—à–∞ 3">
                                    <i class="bi bi-emoji-smile"></i>
                                    <span>–•–æ—Ä–æ—à–æ</span>
                                    <small>3</small>
                                </button>
                                <button class="btn btn-answer btn-easy" @onclick="() => SubmitAnswer(ResponseQuality.Easy)" title="–ö–ª–∞–≤–∏—à–∞ 4">
                                    <i class="bi bi-emoji-laughing"></i>
                                    <span>–õ–µ–≥–∫–æ</span>
                                    <small>4</small>
                                </button>
                            </div>
                            <div class="keyboard-hints">
                                <span><kbd>Space</kbd> –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</span>
                                <span><kbd>1-4</kbd> –≤—ã–±–æ—Ä –æ—Ü–µ–Ω–∫–∏</span>
                            </div>
                        }
                    </div>
                }
                else if (ExerciseType == "mcq")
                {
                    <!-- –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (MCQ) -->
                    <div class="mcq-card">
                        <div class="mcq-question">
                            <div class="word-dictionary">
                                <i class="bi bi-book"></i> @CurrentWord.DictionaryName
                            </div>
                            <div class="word-main">@CurrentWord.OriginalWord</div>
                            @if (!string.IsNullOrEmpty(CurrentWord.Transcription))
                            {
                                <div class="word-transcription">@CurrentWord.Transcription</div>
                            }
                            <div class="audio-group">
                                <button class="btn-tts" @onclick="SpeakWord" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å">
                                    <i class="bi bi-volume-up-fill"></i>
                                </button>
                                <div class="volume-wrapper">
                                    <button class="btn-volume-toggle" @onclick="ToggleVolumeSlider" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
                                        <i class="@VolumeIcon"></i>
                                    </button>
                                    @if (ShowVolumeSlider)
                                    {
                                        <div class="volume-popover">
                                            <input type="range" min="0" max="1" step="0.01"
                                                   value="@TtsVolumeFormatted"
                                                   @oninput="OnVolumeChanged" />
                                            <span class="volume-value">@TtsVolumePercent%</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mcq-options">
                            @foreach (var option in McqOptions)
                            {
                                var isSelected = SelectedMcqOption == option;
                                var isCorrect = option == CurrentWord.Translation;
                                var cssClass = "";
                                
                                if (McqAnswered)
                                {
                                    if (isCorrect)
                                        cssClass = "correct";
                                    else if (isSelected && !isCorrect)
                                        cssClass = "incorrect";
                                }
                                else if (isSelected)
                                {
                                    cssClass = "selected";
                                }

                                <button class="mcq-option @cssClass" 
                                        @onclick="() => SelectMcqOption(option)"
                                        disabled="@McqAnswered">
                                    <span class="option-text">@option</span>
                                    @if (McqAnswered && isCorrect)
                                    {
                                        <i class="bi bi-check-circle-fill"></i>
                                    }
                                    else if (McqAnswered && isSelected && !isCorrect)
                                    {
                                        <i class="bi bi-x-circle-fill"></i>
                                    }
                                </button>
                            }
                        </div>

                        @if (McqAnswered)
                        {
                            <div class="mcq-feedback @(McqWasCorrect ? "success" : "error")">
                                @if (McqWasCorrect)
                                {
                                    <i class="bi bi-check-circle"></i>
                                    <span>–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle"></i>
                                    <span>–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: @CurrentWord.Translation</span>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(CurrentWord.Example))
                            {
                                <div class="example mt-2">
                                    <i class="bi bi-chat-quote"></i> @CurrentWord.Example
                                    <button class="btn-tts-sm" @onclick="SpeakExample" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä">
                                        <i class="bi bi-volume-up"></i>
                                    </button>
                                </div>
                            }
                            <button class="btn btn-primary btn-lg mt-3" @onclick="NextMcqWord">
                                <i class="bi bi-arrow-right me-2"></i>–î–∞–ª–µ–µ
                            </button>
                        }
                    </div>
                }
                else if (ExerciseType == "typing")
                {
                    <!-- –†–µ–∂–∏–º –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ -->
                    <div class="typing-card">
                        <div class="typing-question">
                            <div class="word-dictionary">
                                <i class="bi bi-book"></i> @CurrentWord.DictionaryName
                            </div>
                            <div class="word-main">@CurrentWord.OriginalWord</div>
                            @if (!string.IsNullOrEmpty(CurrentWord.Transcription))
                            {
                                <div class="word-transcription">@CurrentWord.Transcription</div>
                            }
                            <div class="audio-group">
                                <button class="btn-tts" @onclick="SpeakWord" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å">
                                    <i class="bi bi-volume-up-fill"></i>
                                </button>
                                <div class="volume-wrapper">
                                    <button class="btn-volume-toggle" @onclick="ToggleVolumeSlider" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
                                        <i class="@VolumeIcon"></i>
                                    </button>
                                    @if (ShowVolumeSlider)
                                    {
                                        <div class="volume-popover">
                                            <input type="range" min="0" max="1" step="0.01"
                                                   value="@TtsVolumeFormatted"
                                                   @oninput="OnVolumeChanged" />
                                            <span class="volume-value">@TtsVolumePercent%</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="typing-input">
                            <input type="text" class="form-control form-control-lg @(TypingAnswered ? (TypingWasCorrect ? "is-valid" : "is-invalid") : "")" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..."
                                   @bind="TypedAnswer"
                                   @bind:event="oninput"
                                   @onkeypress="HandleTypingKeyPress"
                                   disabled="@TypingAnswered" />
                            
                            @if (!TypingAnswered)
                            {
                                <button class="btn btn-primary btn-lg" @onclick="CheckTypingAnswer">
                                    <i class="bi bi-check-lg me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                </button>
                            }
                        </div>

                        @if (TypingAnswered)
                        {
                            <div class="typing-feedback @(TypingWasCorrect ? "success" : "error")">
                                @if (TypingWasCorrect)
                                {
                                    <i class="bi bi-check-circle"></i>
                                    <span>–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle"></i>
                                    <span>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>@CurrentWord.Translation</strong></span>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(CurrentWord.Example))
                            {
                                <div class="example mt-2">
                                    <i class="bi bi-chat-quote"></i> @CurrentWord.Example
                                    <button class="btn-tts-sm" @onclick="SpeakExample" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä">
                                        <i class="bi bi-volume-up"></i>
                                    </button>
                                </div>
                            }
                            <button class="btn btn-primary btn-lg mt-3" @onclick="NextTypingWord">
                                <i class="bi bi-arrow-right me-2"></i>–î–∞–ª–µ–µ
                            </button>
                        }
                    </div>
                }
            }
            else
            {
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
                <div class="session-results">
                    <div class="results-icon">
                        @if (SessionAccuracy >= 90)
                        {
                            <span>üèÜ</span>
                        }
                        else if (SessionAccuracy >= 70)
                        {
                            <span>üéâ</span>
                        }
                        else if (SessionAccuracy >= 50)
                        {
                            <span>üëç</span>
                        }
                        else
                        {
                            <span>üí™</span>
                        }
                    </div>
                    <h2>@SessionResultMessage</h2>

                    <div class="results-stats">
                        <div class="result-stat">
                            <span class="result-value">@TrainingWords.Count</span>
                            <span class="result-label">–í—Å–µ–≥–æ —Å–ª–æ–≤</span>
                        </div>
                        <div class="result-stat result-correct">
                            <span class="result-value">@SessionCorrectCount</span>
                            <span class="result-label">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                        </div>
                        <div class="result-stat result-wrong">
                            <span class="result-value">@SessionWrongCount</span>
                            <span class="result-label">–° –æ—à–∏–±–∫–∞–º–∏</span>
                        </div>
                        <div class="result-stat">
                            <span class="result-value">@SessionDurationFormatted</span>
                            <span class="result-label">–í—Ä–µ–º—è</span>
                        </div>
                    </div>

                    <!-- Accuracy bar -->
                    <div class="results-accuracy">
                        <div class="accuracy-value">@SessionAccuracy.ToString("F0")%</div>
                        <div class="accuracy-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                        <div class="accuracy-bar-container mt-2">
                            <div class="progress" style="height: 10px; border-radius: 5px; max-width: 300px; margin: 0 auto;">
                                <div class="progress-bar bg-success" style="width: @SessionAccuracy%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Difficult words -->
                    @if (DifficultWordsList.Count > 0)
                    {
                        <div class="difficult-words-section">
                            <h5 class="text-muted mb-2"><i class="bi bi-exclamation-triangle me-1"></i>–°–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏</h5>
                            <div class="difficult-words-list">
                                @foreach (var word in DifficultWordsList)
                                {
                                    <span class="badge bg-danger-subtle text-danger me-1 mb-1 px-3 py-2" style="font-size: 0.9rem;">@word</span>
                                }
                            </div>
                        </div>
                    }

                    <div class="results-actions">
                        <button class="btn btn-primary btn-lg" @onclick="ContinueTraining">
                            <i class="bi bi-arrow-repeat me-2"></i>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                        <button class="btn btn-outline-secondary btn-lg" @onclick="BackToPlan">
                            <i class="bi bi-house me-2"></i>–ö –ø–ª–∞–Ω—É
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
private bool IsAuthenticated;
private bool IsLoading = true;
private bool IsTrainingActive;
private bool IsAnswerRevealed;
private bool IsInstallingStarter;
private string? StarterMessage;
private bool StarterSuccess;

private DailyPlanDto? DailyPlan;
private List<TrainingWordDto> TrainingWords = new();
private TrainingWordDto? CurrentWord;
private int CurrentIndex;
private int CorrectCount;
private string CurrentMode = "mixed";
private string ExerciseType = "flashcard";

// Session tracking
private DateTime SessionStartedAt;
private int SessionCorrectCount;
private int SessionWrongCount;

// MCQ state
private List<string> McqOptions = new();
private string? SelectedMcqOption;
private bool McqAnswered;
private bool McqWasCorrect;

// Typing state
private string TypedAnswer = "";
private bool TypingAnswered;
private bool TypingWasCorrect;
private Random _random = new();

// TTS state
private double TtsVolume = 0.8;
private bool ShowVolumeSlider;

// Results tracking
private List<string> DifficultWordsList = new();
private string _sessionDurationSnapshot = "";

// Element reference for focus
private ElementReference trainingContainer;

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && IsTrainingActive)
    {
        await FocusContainer();
    }
}

private async Task FocusContainer()
{
    try
    {
        await trainingContainer.FocusAsync();
    }
    catch
    {
        // Ignore focus errors
    }
}

private async Task HandleKeyDown(KeyboardEventArgs e)
{
    if (!IsTrainingActive || CurrentWord == null) return;

    if (ExerciseType == "flashcard")
    {
        await HandleFlashcardKeyDown(e);
    }
    else if (ExerciseType == "mcq")
    {
        await HandleMcqKeyDown(e);
    }
    // Typing mode handles its own key events
}

private async Task HandleFlashcardKeyDown(KeyboardEventArgs e)
{
    if (!IsAnswerRevealed)
    {
        // Space to reveal answer
        if (e.Key == " " || e.Key == "Enter")
        {
            RevealAnswer();
            StateHasChanged();
        }
    }
    else
    {
        // 1-4 to rate answer
        switch (e.Key)
        {
            case "1":
                await SubmitAnswer(ResponseQuality.Again);
                break;
            case "2":
                await SubmitAnswer(ResponseQuality.Hard);
                break;
            case "3":
                await SubmitAnswer(ResponseQuality.Good);
                break;
            case "4":
                await SubmitAnswer(ResponseQuality.Easy);
                break;
        }
    }
}

private async Task HandleMcqKeyDown(KeyboardEventArgs e)
{
    if (!McqAnswered)
    {
        // 1-4 to select option
        if (int.TryParse(e.Key, out int num) && num >= 1 && num <= McqOptions.Count)
        {
            await SelectMcqOption(McqOptions[num - 1]);
            StateHasChanged();
        }
    }
    else
    {
        // Enter or Space to continue
        if (e.Key == "Enter" || e.Key == " ")
        {
            await NextMcqWord();
            StateHasChanged();
        }
    }
}

protected override async Task OnInitializedAsync()
{
    await AuthService.InitializeAsync();
    var session = await AuthService.GetCurrentSessionAsync();
    IsAuthenticated = session != null;

    if (IsAuthenticated)
    {
        await LoadDailyPlan();
    }

    IsLoading = false;
}

private async Task LoadDailyPlan()
{
    DailyPlan = await TrainingService.GetDailyPlanAsync();
}

private async Task InstallStarterPack()
{
    IsInstallingStarter = true;
    StarterMessage = null;
    StateHasChanged();

    var result = await TrainingService.InstallStarterPackAsync();

    if (result != null)
    {
        StarterSuccess = true;
        StarterMessage = result.Message;
            await LoadDailyPlan();
        }
        else
        {
            StarterSuccess = false;
            StarterMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä. –í–æ–∑–º–æ–∂–Ω–æ, —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞—Ä–∏.";
        }

        IsInstallingStarter = false;
    }

    private void SetExerciseType(string type)
    {
        ExerciseType = type;
    }

    private async Task StartTraining(string mode)
    {
        CurrentMode = mode;
        IsLoading = true;
        StateHasChanged();

        TrainingWords = await TrainingService.GetTrainingWordsAsync(mode);

        if (TrainingWords.Count > 0)
        {
            CurrentIndex = 0;
            CorrectCount = 0;
            SessionCorrectCount = 0;
            SessionWrongCount = 0;
            DifficultWordsList.Clear();
            SessionStartedAt = DateTime.UtcNow;
            CurrentWord = TrainingWords[0];
            IsAnswerRevealed = false;
            IsTrainingActive = true;
            PrepareCurrentWord();
            await FocusContainer();
        }
        else
        {
            // No words available ‚Äî return to the daily plan view
            IsTrainingActive = false;
            CurrentWord = null;
            CorrectCount = 0;
        }

        IsLoading = false;
    }

    private void PrepareCurrentWord()
    {
        // Reset states
        IsAnswerRevealed = false;
        McqAnswered = false;
        McqWasCorrect = false;
        SelectedMcqOption = null;
        TypingAnswered = false;
        TypingWasCorrect = false;
        TypedAnswer = "";

        // Generate MCQ options if needed
        if (ExerciseType == "mcq" && CurrentWord != null)
        {
            GenerateMcqOptions();
        }
    }

    private void GenerateMcqOptions()
    {
        McqOptions.Clear();
        
        // Add correct answer
        McqOptions.Add(CurrentWord!.Translation);
        
        // Add distractors from other words
        var otherWords = TrainingWords
            .Where(w => w.WordId != CurrentWord.WordId && !string.IsNullOrEmpty(w.Translation))
            .Select(w => w.Translation)
            .Distinct()
            .OrderBy(_ => _random.Next())
            .Take(3)
            .ToList();
        
        McqOptions.AddRange(otherWords);
        
        // If we don't have enough options, add some generic ones
        var genericOptions = new[] { "—Å–ª–æ–≤–æ", "–æ—Ç–≤–µ—Ç", "–ø–µ—Ä–µ–≤–æ–¥", "–∑–Ω–∞—á–µ–Ω–∏–µ" };
        while (McqOptions.Count < 4)
        {
            var option = genericOptions[_random.Next(genericOptions.Length)] + " " + (_random.Next(99) + 1);
            if (!McqOptions.Contains(option))
            {
                McqOptions.Add(option);
            }
        }
        
        // Shuffle options
        McqOptions = McqOptions.OrderBy(_ => _random.Next()).ToList();
    }

    private void RevealAnswer()
    {
        IsAnswerRevealed = true;
    }

    private async Task SubmitAnswer(ResponseQuality quality)
    {
        if (CurrentWord == null) return;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await TrainingService.UpdateProgressAsync(CurrentWord.WordId, quality);

        // –°—á–∏—Ç–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        if (quality >= ResponseQuality.Good)
        {
            CorrectCount++;
            SessionCorrectCount++;
        }
        else
        {
            SessionWrongCount++;
            if (CurrentWord != null && !DifficultWordsList.Contains(CurrentWord.OriginalWord))
                DifficultWordsList.Add(CurrentWord.OriginalWord);
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
        await MoveToNextWord();
    }

    private async Task SelectMcqOption(string option)
    {
        if (McqAnswered || CurrentWord == null) return;
        
        SelectedMcqOption = option;
        McqAnswered = true;
        McqWasCorrect = option.Equals(CurrentWord.Translation, StringComparison.OrdinalIgnoreCase);
        
        // Update progress
        var quality = McqWasCorrect ? ResponseQuality.Good : ResponseQuality.Again;
        await TrainingService.UpdateProgressAsync(CurrentWord.WordId, quality);

        if (McqWasCorrect)
            {
                CorrectCount++;
                SessionCorrectCount++;
            }
            else
            {
                SessionWrongCount++;
                if (CurrentWord != null && !DifficultWordsList.Contains(CurrentWord.OriginalWord))
                    DifficultWordsList.Add(CurrentWord.OriginalWord);
            }
    }

    private async Task NextMcqWord()
    {
        await MoveToNextWord();
    }

    private async Task HandleTypingKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !TypingAnswered)
        {
            await CheckTypingAnswer();
        }
    }

    private async Task CheckTypingAnswer()
    {
        if (TypingAnswered || CurrentWord == null) return;
        
        TypingAnswered = true;
        
        // Normalize answers for comparison
        var userAnswer = TypedAnswer.Trim().ToLowerInvariant();
        var correctAnswer = CurrentWord.Translation.Trim().ToLowerInvariant();

        // Strict comparison with normalization (whitespace, case)
        TypingWasCorrect = userAnswer == correctAnswer;
        
        // Update progress
        var quality = TypingWasCorrect ? ResponseQuality.Good : ResponseQuality.Again;
        await TrainingService.UpdateProgressAsync(CurrentWord.WordId, quality);

        if (TypingWasCorrect)
        {
            CorrectCount++;
            SessionCorrectCount++;
        }
        else
        {
            SessionWrongCount++;
            if (CurrentWord != null && !DifficultWordsList.Contains(CurrentWord.OriginalWord))
                DifficultWordsList.Add(CurrentWord.OriginalWord);
        }
    }

    private async Task NextTypingWord()
    {
        await MoveToNextWord();
    }

    private async Task MoveToNextWord()
    {
        CurrentIndex++;
        if (CurrentIndex < TrainingWords.Count)
        {
            CurrentWord = TrainingWords[CurrentIndex];
            PrepareCurrentWord();
        }
        else
        {
            // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
            CurrentWord = null;
            var elapsed = DateTime.UtcNow - SessionStartedAt;
            if (elapsed.TotalHours >= 1)
                _sessionDurationSnapshot = $"{(int)elapsed.TotalHours}—á {elapsed.Minutes}–º–∏–Ω";
            else if (elapsed.TotalMinutes >= 1)
                _sessionDurationSnapshot = $"{elapsed.Minutes}–º–∏–Ω {elapsed.Seconds}—Å";
            else
                _sessionDurationSnapshot = $"{elapsed.Seconds}—Å";
            await SaveTrainingSessionAsync();
        }
    }

    private async Task SaveTrainingSessionAsync()
    {
        try
        {
            var request = new LearningTrainerWeb.Services.SaveSessionRequest
            {
                StartedAt = SessionStartedAt,
                CompletedAt = DateTime.UtcNow,
                WordsReviewed = TrainingWords.Count,
                CorrectAnswers = SessionCorrectCount,
                WrongAnswers = SessionWrongCount,
                Mode = ExerciseType switch
                {
                    "flashcard" => "Flashcards",
                    "mcq" => "MultipleChoice",
                    "typing" => "Typing",
                    _ => "Mixed"
                },
                DictionaryId = TrainingWords.FirstOrDefault()?.DictionaryId
            };

            await StatsService.SaveSessionAsync(request);
        }
        catch (Exception ex)
        {
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            Console.WriteLine($"Failed to save training session: {ex.Message}");
        }
    }

    private async Task ContinueTraining()
    {
        await LoadDailyPlan();
        await StartTraining(CurrentMode);
    }

    private async Task BackToPlan()
    {
        await LoadDailyPlan();
        IsTrainingActive = false;
        CurrentWord = null;
    }

    private async Task SpeakWord()
    {
        if (CurrentWord != null)
        {
            await JS.InvokeVoidAsync("speakText", CurrentWord.OriginalWord, "en-US", TtsVolume);
        }
    }

    private async Task SpeakExample()
    {
        if (CurrentWord != null && !string.IsNullOrEmpty(CurrentWord.Example))
        {
            await JS.InvokeVoidAsync("speakText", CurrentWord.Example, "en-US", TtsVolume);
        }
    }

    private void ToggleVolumeSlider()
    {
        ShowVolumeSlider = !ShowVolumeSlider;
    }

    private void OnVolumeChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var vol))
        {
            TtsVolume = Math.Max(0, Math.Min(1, vol));
        }
    }

    private string VolumeIcon => TtsVolume == 0 ? "bi-volume-mute" : TtsVolume < 0.5 ? "bi-volume-down" : "bi-volume-up";

    private string TtsVolumeFormatted => TtsVolume.ToString(System.Globalization.CultureInfo.InvariantCulture);

    private int TtsVolumePercent => (int)(TtsVolume * 100);

    private double SessionAccuracy => TrainingWords.Count > 0
        ? Math.Round((double)SessionCorrectCount / TrainingWords.Count * 100, 0)
        : 0;

    private string SessionResultMessage => SessionAccuracy switch
    {
        >= 90 => "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ!",
        >= 70 => "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!",
        >= 50 => "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!",
        _ => "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!"
    };

    private string SessionDurationFormatted => _sessionDurationSnapshot;
}
